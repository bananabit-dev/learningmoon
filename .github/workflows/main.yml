name: Build and Deploy learning moon app

on:
    push:
        branches:
            - main
jobs:
    build-deploy:
        name: Build and Deploy learning moon app
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Rust toolchain
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: nightly
                  override: true
                  components: rustfmt, clippy
            
            - name: Run cargo check
              uses: actions-rs/cargo@v1
              with:
                  command: check            
            - name: Run tests
              uses: actions-rs/cargo@v1
              with:
                  command: test

            - name: Get cargo-binstall
              run: |
               curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
            - name: Get Dioxus-CLI
              run: yes | cargo binstall dioxus-cli@0.7.0-rc.0 --disable-telemetry

            - name: Build the application
              run: | 
                dx bundle --web
              
            - name: Build the Docker image
              uses: docker/build-push-action@v2
              with:
                context: .
                push: false
                tags: ${{ secrets.DOCKER_HUB_USERNAME }}/learningmoon:latest
              
            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                username: ${{ secrets.DOCKER_HUB_USERNAME }}
                password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

            - name: Push to Docker Hub
              uses: docker/build-push-action@v2
              with:
                context: .
                push: true
                tags: ${{ secrets.DOCKER_HUB_USERNAME }}/learningmoon:latest


